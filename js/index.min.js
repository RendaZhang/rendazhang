document.addEventListener('DOMContentLoaded', function () {
    var wechatLink = document.getElementById('wechatLink');
    var modal = document.getElementById('wechatModal');
    var closeBtn = modal.querySelector('.close');
    var qrImg = document.getElementById('wechatQR');
    var loader = modal.querySelector('.loader');

    function openModal(event) {
        if (event) event.preventDefault();
        modal.style.display = 'flex';
        loader.style.display = 'block';
        qrImg.style.display = 'none';
        if (!qrImg.getAttribute('src')) {
            qrImg.setAttribute('src', qrImg.getAttribute('data-src'));
        }
        if (!qrImg.complete) {
            qrImg.onload = function () {
                loader.style.display = 'none';
                qrImg.style.display = 'block';
            };
        } else {
            loader.style.display = 'none';
            qrImg.style.display = 'block';
        }
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    wechatLink.addEventListener('mouseenter', openModal);
    wechatLink.addEventListener('click', openModal);
    wechatLink.addEventListener('touchstart', openModal);
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function (e) {
        if (e.target === modal) closeModal();
    });
});