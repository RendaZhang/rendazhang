document.addEventListener("DOMContentLoaded", function() {
    const chatInput = document.getElementById("chatInput");
    const chatSendButton = document.getElementById("chatSendButton");
    const chatMessages = document.getElementById("chatMessages");

    chatSendButton.addEventListener("click", function() {
        const message = chatInput.value.trim();
        if (message) {
            displayChatMessage("user", message);
            chatInput.value = "";
            sendChatMessage(message);
        }
    });

    chatInput.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            chatSendButton.click();
        }
    });
});

function displayChatMessage(role, message) {
    const chatMessages = document.getElementById("chatMessages");
    const messageElem = document.createElement("div");
    messageElem.classList.add("chatMessage", role);
    messageElem.innerText = message;
    chatMessages.appendChild(messageElem);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function sendChatMessage(message) {
    fetch('/cloudchat/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({message: message})
    })
    .then(response => {
        // Read the response as a stream
        const reader = response.body.getReader();
        return new ReadableStream({
            async start(controller) {
                while (true) {
                    const {done, value} = await reader.read();

                    // When there's no more data, break the loop
                    if (done) break;

                    // Convert bytes to string and enqueue it
                    controller.enqueue(new TextDecoder().decode(value));
                }

                controller.close();
                reader.releaseLock();
            }
        });
    })
    .then(stream => {
        // Convert the stream into a text
        return new Response(stream).text();
    })
    .then(result => {
        displayChatMessage("assistant", result.trim());
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
