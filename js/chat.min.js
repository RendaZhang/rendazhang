document.addEventListener("DOMContentLoaded", function() {
    const chatInput = document.getElementById("chat-input");
    const chatSendButton = document.getElementById("chat-send-button");
    const chatMessages = document.querySelector(".chat-messages");

    function appendMessage(sender, message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = sender;
        messageDiv.innerText = message;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatSendButton.addEventListener("click", function() {
        const userMessage = chatInput.value.trim();
        if (userMessage) {
            appendMessage("user", userMessage);
            chatInput.value = "";

            fetch("/cloudchat/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ message: userMessage })
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let lastReceived = "";

                function processStream() {
                    return reader.read().then(({ value, done }) => {
                        if (done) return;
                        const chunk = decoder.decode(value, { stream: true });
                        const completeResponses = (lastReceived + chunk).split("\n");
                        lastReceived = completeResponses.pop();

                        completeResponses.forEach(response => {
                            const message = JSON.parse(response).text;
                            appendMessage("bot", message);
                        });

                        return processStream();
                    });
                }

                return processStream();
            }).catch(error => {
                console.error("Error:", error);
                appendMessage("error", "An error occurred while processing your request.");
            });
        }
    });
});
