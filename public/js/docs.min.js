document.addEventListener('DOMContentLoaded', function () {
  $.when($.get('/README.md'), $.get('/README_EN.md'))
    .done(function (zhRes, enRes) {
      var zhData = zhRes[0];
      var enData = enRes[0];

      var htmlZh = marked.parse(zhData);
      var htmlEn = marked.parse(enData);

      var tocMatch = htmlEn.match(/<!-- START doctoc[\s\S]*?-->([\s\S]*?)<!-- END doctoc/);
      var anchorIds = [];
      if (tocMatch) {
        var temp = document.createElement('div');
        temp.innerHTML = tocMatch[1];
        anchorIds = Array.from(temp.querySelectorAll('a[href^="#"]')).map(function (a) {
          return a.getAttribute('href').slice(1);
        });
      }

      var parser = new DOMParser();
      var docZh = parser.parseFromString(htmlZh, 'text/html');
      var docEn = parser.parseFromString(htmlEn, 'text/html');

      if (anchorIds.length) {
        var headingsZh = docZh.querySelectorAll('h1, h2, h3, h4, h5, h6');
        var headingsEn = docEn.querySelectorAll('h1, h2, h3, h4, h5, h6');
        anchorIds.forEach(function (id, i) {
          if (headingsZh[i]) headingsZh[i].id = id;
          if (headingsEn[i]) headingsEn[i].id = id;
        });
      }

      document.getElementById('content-zh').innerHTML = docZh.body.innerHTML;
      document.getElementById('content-en').innerHTML = docEn.body.innerHTML;

      var loadScript = function (src, callback) {
        var script = document.createElement('script');
        script.src = src;
        script.onload = callback;
        document.head.appendChild(script);
      };

      Promise.all([
        new Promise(function (resolve) {
          loadScript('/js/highlight.min.js', resolve);
        }),
        new Promise(function (resolve) {
          loadScript('/js/mermaid.min.js', resolve);
        })
      ]).then(function () {
        document.querySelectorAll('pre code:not(.language-mermaid)').forEach(function (block) {
          hljs.highlightElement(block);
        });
        mermaid.initialize({ startOnLoad: false });
        mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
        console.log('All enhancements applied');
      });
    })
    .fail(function () {
      document.getElementById('content-zh').innerHTML = '<p>Error loading documentation</p>';
      document.getElementById('content-en').innerHTML = '<p>Error loading documentation</p>';
    });
});
