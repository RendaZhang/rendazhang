const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/mermaid.core.BFYvPj1V.js","_astro/purify.es.Cd42A1hC.js","_astro/certifications.9f0375e8.B4Uv7KUm.js","_astro/index.CEq_y5-P.js","_astro/index.-_oy9bZA.js","_astro/logger.BoW92lqO.js","_astro/_commonjsHelpers.DJ8JrvF2.js","_astro/index.DBkwFVeZ.js","_astro/index.DhV4RjQ8.js"])))=>i.map(i=>d[i]);
import{E as V,J,s as _,L as Y,A as oe,a as ae,M as ie,S as G,R as y,j as e,U as ce,u as le,I as N}from"./index.CEq_y5-P.js";import{p as de,k as ue,_ as M,A as he}from"./purify.es.Cd42A1hC.js";import{r}from"./index.-_oy9bZA.js";import"./certifications.9f0375e8.B4Uv7KUm.js";import{l as H}from"./logger.BoW92lqO.js";import{L as E,C as fe,S as me}from"./LocalizedSection.BHVDJlx-.js";import{M as ge}from"./Modal.LoMuAfPB.js";(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t.SENTRY_RELEASE={id:"7f587daaa12957af3a9439f51c5d6fbb4d7b3f42"}})();try{(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},n=new t.Error().stack;n&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[n]="9478905c-2993-41f7-99d0-7e5df709ed6b",t._sentryDebugIdIdentifier="sentry-dbid-9478905c-2993-41f7-99d0-7e5df709ed6b")})()}catch{}const q={en:{title:"AI Chat",description:"Chat with an AI assistant powered by DeepSeek.",loading:"Loading conversation...",chatReady:"Conversation ready. Type a message to start.",coreLoadFailed:"Failed to load core resources. Please refresh.",enhancementProgress:"Enhancing readability...",enhancementFailed:"Enhancement failed, basic features unaffected",placeholders:{loading:"Loading conversation, please wait...",error:"Core resources failed to load",default:"Enter message..."},resetConfirm:"Are you sure you want to reset the conversation? This will clear all history.",resetFailedPrefix:"Reset failed",sendButton:"Send",resetButton:"Reset",confirmButtom:"OK",cancelButton:"Cancel",copyLabel:"Copy",copiedLabel:"Copied"},zh:{title:"AI 对话",description:"由 DeepSeek 提供支持的 AI 助手",loading:"加载对话中...",chatReady:"会话已准备，请输入消息开始对话",coreLoadFailed:"核心资源加载失败，请刷新尝试",enhancementProgress:"正在优化阅读体验...",enhancementFailed:"优化功能加载失败，基础功能不受影响",placeholders:{loading:"加载对话中，请稍候...",error:"核心资源加载失败",default:"输入消息..."},resetConfirm:"确定要重置会话吗？将清除所有历史记录。",resetFailedPrefix:"重置失败",sendButton:"发送",resetButton:"重置会话",confirmButton:"确定",cancelButton:"取消",copyLabel:"复制",copiedLabel:"已复制"}};async function pe(t,n){try{const s=await fetch(V.CHAT,{method:"POST",headers:J,body:JSON.stringify({message:t}),credentials:"include"});if(s.status===401)throw _.remove(Y),document.documentElement.dataset.loggedIn="false",window.location.href="/login",new Error("Unauthorized");if(!s.ok)throw new Error(`Request failed: ${s.status}`);const o=s.body?.getReader();if(!o)throw new Error("Readable stream not supported");const i=new TextDecoder;let a="";for(;;){const{value:c,done:d}=await o.read();if(d)break;const h=i.decode(c,{stream:!0}).split(`
`).filter(f=>f.trim());for(const f of h)try{const l=JSON.parse(f);l.text&&(a+=l.text,n&&n(a))}catch(l){H.error("Parse error:",l)}}return a}catch(s){throw H.error("API error:",s),s}}async function ye(){try{const t=await fetch(V.RESET,{method:"POST",headers:J,body:JSON.stringify({}),credentials:"include"});if(t.status===401)throw _.remove(Y),document.documentElement.dataset.loggedIn="false",window.location.href="/login",new Error("Unauthorized");if(!t.ok)throw new Error(`Reset failed: ${t.status}`);return!0}catch(t){throw H.error("Reset error:",t),t}}class xe{history;constructor(n=[]){this.history=Array.isArray(n)?[...n]:[],this.trimHistory()}countTokens(n){return Math.ceil(n.content.length/oe*ae)}trimHistory(){let n=this.history.reduce((s,o)=>s+this.countTokens(o),0);for(;n>ie&&this.history.length>0;)this.history.shift(),n=this.history.reduce((s,o)=>s+this.countTokens(o),0)}addMessage(n,s){return this.history.push({role:n,content:s}),this.trimHistory(),this.getHistory()}setHistory(n){this.history=Array.isArray(n)?[...n]:[],this.trimHistory()}getHistory(){return[...this.history]}clear(){this.history=[]}}function we(){const t=r.useRef(new xe),[n,s]=r.useState([]),[o,i]=r.useState(!1);r.useEffect(()=>{const f=(_.get(G)||[]).map(l=>({role:l.role===y.ASSISTANT?y.AI:y.USER,content:l.content}));t.current.setHistory(f),s(t.current.getHistory()),i(!0)},[]);const a=h=>{_.set(G,h.map(f=>({role:f.role===y.AI?y.ASSISTANT:y.USER,content:f.content})))};return{messages:n,addMessage:(h,f)=>{const l=t.current.addMessage(h,f);return a(l),s(t.current.getHistory()),l},setMessages:h=>{const f=t.current.getHistory(),l=typeof h=="function"?h(f):h;t.current.setHistory(l);const g=t.current.getHistory();return a(g),s(g),g},clearHistory:()=>{t.current.clear(),a([]),s(t.current.getHistory())},isLoaded:o}}let U=!1;async function Ee(t){if(!t)return;const{default:n}=await M(async()=>{const{default:o}=await import("./mermaid.core.BFYvPj1V.js").then(i=>i.bC);return{default:o}},__vite__mapDeps([0,1,2,3,4,5,6]));U||(n.initialize({startOnLoad:!1}),U=!0);const s=t.querySelectorAll("pre code.language-mermaid, pre code.mermaid");for(const o of Array.from(s)){const i=o.parentElement,a=o.textContent||"";try{typeof n.parse=="function"&&await n.parse(a);const{svg:c,bindFunctions:d}=await n.render(`mmd-${Math.random().toString(36).slice(2)}`,a),u=document.createElement("div");u.innerHTML=c,d?.(u),i.replaceWith(u)}catch(c){H.error("Mermaid render error:",c)}}}async function je(t){if(!t)return;const{default:n}=await M(async()=>{const{default:s}=await import("./index.DBkwFVeZ.js");return{default:s}},__vite__mapDeps([7,8,6]));t.querySelectorAll("pre code").forEach(s=>{s.classList.contains("language-mermaid")||s.classList.contains("mermaid")||n.highlightElement(s)}),await Ee(t)}function be(t,n,s){const o=r.useRef(null);return r.useEffect(()=>{if(!o.current)return;const i=de.sanitize(ue.parse(t||""));o.current.innerHTML=i;const a=()=>{typeof s=="function"&&s()};n?je(o.current).then(a):a()},[t,n,s]),o}function Ce({text:t,enhance:n,onRendered:s,textsZh:o,textsEn:i}){const[a,c]=r.useState(!1),[d,u]=r.useState(!1),h=be(t,n,s),f=A=>{A.stopPropagation(),navigator.clipboard.writeText(t).then(()=>{u(!0),setTimeout(()=>{u(!1),c(!1)},ce.COPY_FEEDBACK)})},l=()=>c(!0),g=()=>{d||c(!1)},L=()=>c(!0);return e.jsxs("div",{className:"c-message c-ai-message c-markdown-body",onMouseEnter:l,onMouseLeave:g,onClick:L,children:[e.jsx("button",{className:"c-copy-btn rounded-4",onClick:f,style:{display:a?"inline-block":"none"},children:d?e.jsx(E,{zhContent:o.copiedLabel,enContent:i.copiedLabel}):e.jsx(E,{zhContent:o.copyLabel,enContent:i.copyLabel})}),e.jsx("div",{ref:h})]})}function Le({messages:t,isSending:n,librariesLoaded:s,textsZh:o,textsEn:i,onRendered:a}){return t.map((c,d)=>{if(c.role===y.AI){const u=n&&d===t.length-1;return e.jsx(Ce,{text:c.content,enhance:s&&!u,onRendered:a,textsZh:o,textsEn:i},d)}return e.jsx("div",{className:"c-message c-user-message",children:c.content},d)})}function Re({value:t,onChange:n,onSend:s,onReset:o,onKeyDown:i,disabled:a,placeholder:c,inputRef:d,textsEn:u}){return e.jsxs("div",{className:"c-input-area",children:[e.jsx("textarea",{className:"c-message-input",ref:d,value:t,onChange:h=>n(h.target.value),onKeyDown:i,disabled:a,placeholder:c,rows:1,autoFocus:!0}),e.jsxs("div",{className:"c-btn-container",children:[e.jsx("button",{id:"send-btn",className:"c-btn-primary c-btn-chat c-send-btn",onClick:s,disabled:a,"aria-label":u.sendButton,children:e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:[e.jsx("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),e.jsx("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})}),e.jsx("button",{id:"reset-btn",className:"c-btn-secondary c-btn-chat c-reset-btn",onClick:o,disabled:a,"aria-label":u.resetButton,children:e.jsxs("svg",{viewBox:"0 0 24 24",width:"24",height:"24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"})]})})]})]})}function Se({innerRef:t}){return e.jsxs("div",{className:"c-typing-indicator",id:"typing-indicator",ref:t,children:[e.jsx("span",{className:"c-typing-dot"}),e.jsx("span",{className:"c-typing-dot"}),e.jsx("span",{className:"c-typing-dot"})]})}function ve({isError:t,textsZh:n,textsEn:s}){return e.jsx("div",{id:"c-loading-indicator",className:"c-loading-indicator",role:"status","aria-live":"polite",children:t?e.jsx("p",{className:"c-loading-indicator-text",children:e.jsx(E,{zhContent:n.coreLoadFailed,enContent:s.coreLoadFailed})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"c-chat-widget-skeleton c-skeleton-shimmer","aria-hidden":"true"}),e.jsx("p",{className:"c-loading-indicator-text",children:e.jsx(E,{zhContent:n.loading,enContent:s.loading})})]})})}function Te({texts:t=q}){const{lang:n}=le(),s=n&&n.startsWith("zh")?"zh":"en",o=t.zh,i=t.en,a=s==="zh"?o:i,{messages:c,addMessage:d,setMessages:u,clearHistory:h,isLoaded:f}=we(),[l,g]=r.useState(""),[L,A]=r.useState(!1),[O,B]=r.useState(!1),[X,v]=r.useState(!1),[z,F]=r.useState(null),[Q,W]=r.useState(""),p=r.useRef(null),j=r.useRef(null),R=r.useRef(null),[T,Z]=r.useState(!1),[P,ee]=r.useState(!1),I=r.useRef(!1),k=r.useRef(!1),w=f,te=r.useCallback(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight),I.current||(window.parent?.postMessage({type:"chat-page-ready"},"*"),I.current=!0),T&&!k.current&&(window.parent?.postMessage({type:"chat-enhancement-ready"},"*"),k.current=!0)},[T]);r.useEffect(()=>{(async()=>{try{await Promise.all([M(()=>import("./index.DBkwFVeZ.js"),__vite__mapDeps([7,8,6])),M(()=>import("./mermaid.core.BFYvPj1V.js").then(x=>x.bC),__vite__mapDeps([0,1,2,3,4,5,6]))]),Z(!0)}catch(x){console.error("Failed to load enhancement libraries",x),ee(!0)}})()},[]),r.useEffect(()=>{w&&c.length===0&&!I.current&&(window.parent?.postMessage({type:"chat-page-ready"},"*"),I.current=!0)},[w,c.length]),r.useEffect(()=>{w&&T&&c.length===0&&!k.current&&(window.parent?.postMessage({type:"chat-enhancement-ready"},"*"),k.current=!0)},[w,T,c.length]),r.useEffect(()=>{j.current&&(j.current.style.height="auto",j.current.style.height=`${j.current.scrollHeight}px`)},[l]),r.useEffect(()=>{p.current&&(p.current.scrollTop=p.current.scrollHeight)},[c]),r.useEffect(()=>{W(w?a.placeholders.default:P?a.placeholders.error:a.placeholders.loading)},[s,a,w,P]),r.useEffect(()=>{w&&j.current&&j.current.focus()},[w]),r.useEffect(()=>{const m=j.current;if(!m)return;const x=()=>{typeof m.scrollIntoView=="function"?m.scrollIntoView({block:"nearest"}):window.scrollTo({top:m.offsetTop})};return m.addEventListener("focus",x),()=>{m.removeEventListener("focus",x)}},[]);const K=async()=>{const m=l.trim();if(!m)return;d(y.USER,m),g(""),A(!0),R.current&&(R.current.style.display="block");let x=!1;try{const D=await pe(m,S=>{x||(x=!0,R.current&&(R.current.style.display="none")),u(b=>{const C=b[b.length-1];return C&&C.role===y.AI?(C.content=S,[...b.slice(0,-1),{...C}]):[...b,{role:y.AI,content:S}]}),p.current&&(p.current.scrollTop=p.current.scrollHeight)});u(S=>{const b=[...S],C=b[b.length-1];return C&&C.role===y.AI&&(C.content=D),b})}catch(D){const S=D;d(y.AI,`Error: ${S.message}`)}finally{A(!1),R.current&&(R.current.style.display="none"),p.current&&(p.current.scrollTop=p.current.scrollHeight)}},ne=async()=>{v(!0),F(null)},se=async()=>{B(!0);try{await ye(),h(),v(!1)}catch(m){const x=m;F(`${a.resetFailedPrefix}: ${x.message}`)}finally{B(!1)}},re=m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),K())};return e.jsxs("div",{className:"c-chat-wrapper",children:[e.jsx("header",{className:"c-app-header",children:e.jsx("h1",{children:e.jsx(E,{zhContent:o.title,enContent:i.title})})}),e.jsx("div",{className:"c-chat-container",id:"chat-container",ref:p,children:w?c.length===0?e.jsx("div",{className:"c-info-text",children:e.jsx(E,{zhContent:o.chatReady,enContent:i.chatReady})}):e.jsx(Le,{messages:c,isSending:L,librariesLoaded:T,textsZh:o,textsEn:i,onRendered:te}):e.jsx(ve,{isError:P,textsZh:o,textsEn:i})}),e.jsx(Se,{innerRef:R}),e.jsx(Re,{value:l,onChange:g,onSend:K,onReset:ne,onKeyDown:re,disabled:!w||L||O,placeholder:Q,inputRef:j,textsEn:i}),e.jsx(ge,{isOpen:X,onClose:()=>!O&&v(!1),children:z?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:z}),e.jsx("button",{className:"c-btn-primary c-btn-chat",onClick:()=>v(!1),children:e.jsx(E,{zhContent:o.confirmButton,enContent:i.confirmButtom})})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:e.jsx(E,{zhContent:o.resetConfirm,enContent:i.resetConfirm})}),O?e.jsx("div",{className:"c-loader"}):e.jsxs("div",{className:"c-btn-container",style:{justifyContent:"center"},children:[e.jsx("button",{className:"c-btn-secondary c-btn-chat",onClick:()=>v(!1),children:e.jsx(E,{zhContent:o.cancelButton,enContent:i.cancelButton})}),e.jsx("button",{className:"c-btn-primary c-btn-chat",onClick:se,children:e.jsx(E,{zhContent:o.resetButton,enContent:i.resetButton})})]})]})})]})}function Be(){return e.jsx(Te,{texts:q})}const $=new Set;function Ae(t){if($.has(t)||document.querySelector(`link[href="${t}"]`))return;const n=document.createElement("link");n.rel="stylesheet",n.href=t,document.head.appendChild(n),$.add(t)}function Ie({size:t=N.DEFAULT}){return e.jsxs("svg",{width:t,height:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"7",width:"18",height:"12",rx:"2"}),e.jsx("path",{d:"M12 3v4"}),e.jsx("circle",{cx:"9",cy:"13",r:"1"}),e.jsx("circle",{cx:"15",cy:"13",r:"1"}),e.jsx("path",{d:"M5 19v2h14v-2"})]})}function ke({size:t=N.DEFAULT}){return e.jsxs("svg",{width:t,height:t,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}function ze({defaultOpen:t=!1}){const[n,s]=r.useState(t),[o,i]=r.useState(t),[a,c]=r.useState(!1),d=r.useRef(null),u=r.useRef(null),h=r.useRef(null);r.useEffect(()=>{Ae(me.CHAT_WIDGET)},[]);const f=()=>s(l=>!l);return r.useEffect(()=>{n&&!o&&i(!0),n||c(!1)},[n,o]),r.useEffect(()=>{if(!n)return;const l=g=>{const L=g.target;d.current&&!d.current.contains(L)&&u.current&&!u.current.contains(L)&&s(!1)};return document.addEventListener("mousedown",l),()=>{document.removeEventListener("mousedown",l)}},[n]),r.useEffect(()=>{const l=g=>{g.source===h.current?.contentWindow&&g.data?.type==="chat-enhancement-ready"&&c(!0)};return window.addEventListener("message",l),()=>{window.removeEventListener("message",l)}},[]),e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{ref:d,className:"c-chat-widget-panel bg-surface rounded-8 shadow-medium",children:o&&e.jsxs("div",{className:"c-chat-widget-frame-wrapper","aria-busy":!a,children:[e.jsx("iframe",{ref:h,src:`${fe}/`,title:he,className:`c-chat-widget-iframe ${a?"is-loaded":""}`,loading:"lazy"}),!a&&e.jsx("div",{className:"c-chat-widget-skeleton c-skeleton-shimmer","aria-hidden":"true"})]})}),e.jsx("button",{ref:u,className:"c-chat-widget-toggle u-flex-center shadow-medium u-fixed-bottom-right",onClick:f,"aria-label":n?"Close Assistant":"Open Assistant",children:n?e.jsx(ke,{size:N.LARGE}):e.jsx(Ie,{size:N.LARGE})})]})}export{ze as ChatWidget,Be as DeepseekChatContent};
//# sourceMappingURL=chat.BxNFDHjj.js.map
