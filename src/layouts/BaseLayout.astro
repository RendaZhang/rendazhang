---
import NavBarWrapper from '../components/NavBarWrapper.jsx';
import { FAVICON_PATH, STYLE_PATHS, VIEWPORT_ZOOM_ALLOWED, PERSON_SCHEMA } from '../config.js';

const {
  lang = 'en',
  title = '',
  description = '',
  viewport = VIEWPORT_ZOOM_ALLOWED,
  canonical = '',
  personSchemaJson = JSON.stringify(PERSON_SCHEMA),
  extraStyles = [],
  preloadStyles = [],
  extraScripts = [],
  showNav = true,
  showFooter = false,
  bodyClass = '',
  mainClass = 'main-content',
  bodyAttrs = {},
  mainAttrs = {}
} = Astro.props;

const jsonLD = personSchemaJson;
---

<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content={viewport} />
    {title && <title>{title}</title>}
    {description && <meta name="description" content={description} />}
    <link rel="shortcut icon" type="image/x-icon" href={FAVICON_PATH} />
    <link rel="icon" type="image/png" href={FAVICON_PATH} />
    <link rel="apple-touch-icon" href={FAVICON_PATH} />
    <script is:inline>
      (function () {
        try {
          // 1. 尝试读取本地存储
          const storedTheme = localStorage.getItem('preferred_theme');
          // 2. 如果无存储值，检测系统偏好
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          // 3. 决策逻辑
          const shouldUseDarkMode = storedTheme === 'dark' || (!storedTheme && systemPrefersDark);
          // 4. 立即应用主题
          if (shouldUseDarkMode) {
            document.documentElement.classList.add('dark-mode');
          }
          // 5. 设置数据属性供React使用
          document.documentElement.dataset.initialTheme =
            storedTheme || (systemPrefersDark ? 'dark' : 'light');
        } catch (e) {
          console.error('主题初始化失败', e);
        }
      })();
    </script>
    <!-- Load Bootstrap first so custom styles can override -->
    <link rel="stylesheet" href={STYLE_PATHS.BOOTSTRAP} />
    <link rel="stylesheet" href={STYLE_PATHS.THEME} />
    <link rel="canonical" href={canonical} />
    <script type="application/ld+json" set:html={jsonLD} />
    {
      preloadStyles.map((href: string | URL | null | undefined) => (
        <link rel="preload" href={href} as="style" />
      ))
    }
    {
      extraStyles.map((href: string | URL | null | undefined) => (
        <link rel="stylesheet" href={href} />
      ))
    }
    <slot name="head" />
  </head>
  <body class={bodyClass} {...bodyAttrs}>
    {
      showNav ? (
        <slot name="nav">
          <NavBarWrapper client:load />
        </slot>
      ) : null
    }
    <main class={mainClass} {...mainAttrs}>
      <!-- 页面主体内容插槽 -->
      <slot />
    </main>
    <slot name="bodyEnd" />
    {showFooter && <slot name="footer" />}
    {extraScripts.map((src: string | null | undefined) => <script defer src={src} />)}
  </body>
</html>
